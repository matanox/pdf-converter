// Generated by CoffeeScript 1.6.3
var enableContext, go, reload, startAfterPrerequisites, startEventMgmt;

Array.prototype.unique = function() {
  var key, output, value, _i, _ref, _results;
  output = {};
  for (key = _i = 0, _ref = this.length; 0 <= _ref ? _i < _ref : _i > _ref; key = 0 <= _ref ? ++_i : --_i) {
    output[this[key]] = this[key];
  }
  _results = [];
  for (key in output) {
    value = output[key];
    _results.push(value);
  }
  return _results;
};

startAfterPrerequisites = function() {
  var ajaxRequest;
  ajaxRequest = new XMLHttpRequest();
  ajaxRequest.onreadystatechange = function() {
    var inject, script;
    if (ajaxRequest.readyState === 4) {
      if (ajaxRequest.status === 200) {
        console.log('Ajax fetching javascript succeeded.');
        console.log('Proceeding to start processing after fetched javascript will have been fully loaded');
        script = document.createElement("script");
        script.type = "text/javascript";
        inject = ajaxRequest.responseText + '\n' + 'go()';
        script.innerHTML = inject;
        return document.getElementsByTagName("head")[0].appendChild(script);
      } else {
        return console.error('Failed loading prerequisite library via ajax. Aborting...');
      }
    }
  };
  ajaxRequest.open('GET', 'javascripts/external/color.js', true);
  return ajaxRequest.send(null);
};

startEventMgmt = function() {
  var Color, baseMarkColor, container, contextmenuHandler, dragElements, endDrag, inDrag, inDragMaybe, leftDown, mark, mousemoveHandler, noColor, page;
  console.log("Setting up events...");
  container = document.getElementById('hookPoint');
  page = document.body;
  leftDown = false;
  inDragMaybe = false;
  inDrag = false;
  dragElements = new Array();
  Color = net.brehaut.Color;
  baseMarkColor = Color('#FAA058');
  noColor = Color('#000000');
  mark = function(elements) {
    var currentColor, currentCssBackground, element, i, newColor, _i, _ref, _ref1;
    for (i = _i = _ref = Math.min.apply(null, elements), _ref1 = Math.max.apply(null, elements); _ref <= _ref1 ? _i <= _ref1 : _i >= _ref1; i = _ref <= _ref1 ? ++_i : --_i) {
      element = document.getElementById(i);
      currentCssBackground = window.getComputedStyle(element, null).getPropertyValue('background-color');
      if (currentCssBackground != null) {
        currentColor = Color().fromObject(currentCssBackground);
        console.log(currentColor.toCSSHex(), noColor.toCSSHex());
        if (currentColor.toCSSHex() === noColor.toCSSHex()) {
          console.log('no background found');
          newColor = baseMarkColor;
        } else {
          newColor = currentColor.darkenByRatio(0.05);
        }
        element.style.background = newColor.toCSS();
      }
    }
    /*
    # Further highlight more the words actually hovered,
    # but not those that were only part of the selected range
    for element in elements
      document.getElementById(element).style.background = '#FAAC58'
    */

    return dragElements = new Array();
  };
  endDrag = function() {
    var inDrabMaybe;
    container.removeEventListener("mousemove", mousemoveHandler, false);
    inDrag = false;
    inDrabMaybe = false;
    console.log("drag ended");
    if (dragElements.length > 0) {
      return mark(dragElements.unique());
    }
  };
  mousemoveHandler = function(event) {
    if (inDragMaybe === true) {
      inDrag = true;
      console.log('dragging');
      inDragMaybe = false;
    }
    if (inDrag && (event.target !== container)) {
      return dragElements.push(event.target.id);
    }
  };
  contextmenuHandler = function(event) {
    var remove;
    remove = function(node) {
      return node.parentNode.removeChild(node);
    };
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
    console.log("right-click event captured");
    console.log(event.target);
    if (event.target !== event.currentTarget) {
      remove(event.target);
    }
    return false;
  };
  container.addEventListener("contextmenu", contextmenuHandler);
  container.onclick = function(event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
    console.log("click event captured");
    return false;
  };
  container.ondblclick = function(event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
    console.log("double-click event captured");
    return false;
  };
  page.onmouseup = function(event) {
    if (event.button === 0) {
      leftDown = false;
    }
    inDragMaybe = false;
    if (inDrag === true) {
      endDrag();
    }
    return false;
  };
  page.onmousedown = function(event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
    console.log("mouse-down event captured");
    if (event.button === 0) {
      leftDown = true;
      if (event.target !== container) {
        inDragMaybe = true;
        container.addEventListener("mousemove", mousemoveHandler, false);
      }
    }
    return false;
  };
  return container.onselectstart = function(event) {
    event.preventDefault();
    event.stopPropagation();
    event.stopImmediatePropagation();
    console.log("select-start event captured");
    return false;
  };
};

go = function() {
  return window.onload = function() {
    return startEventMgmt();
  };
};

startAfterPrerequisites();

reload = function() {
  var script;
  script = document.createElement("script");
  script.type = "text/javascript";
  script.src = "javascripts/events.js";
  document.getElementsByTagName("head")[0].appendChild(script);
  startEventMgmt();
  return console.log('reloaded');
};

enableContext = function() {
  return document.getElementById("hookPoint").removeEventListener("contextmenu", contextmenuHandler);
};

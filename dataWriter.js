// Generated by CoffeeScript 1.6.3
var docDataDir, files, logging, myWriter, util;

logging = require('./logging');

myWriter = require('./writer');

util = require('./util');

docDataDir = 'docData/';

exports.docDataDir = docDataDir;

files = {};

exports.write = function(inputFileName, dataType, data) {
  var nameBase, now, writer;
  if (files[inputFileName] == null) {
    files[inputFileName] = {};
  }
  if (files[inputFileName][dataType] == null) {
    console.log("opening writer for " + dataType);
    util.mkdir(docDataDir, inputFileName);
    now = new Date();
    nameBase = docDataDir + '/' + inputFileName + '/' + dataType + '-' + now.toISOString() + '.out';
    writer = new myWriter(nameBase);
    logging.cond("Data writing for [" + inputFileName + "], [" + dataType + "] is going to " + nameBase, 'dataWriter');
    files[inputFileName][dataType] = writer;
  }
  files[inputFileName][dataType].write(data);
  return true;
};

exports.close = function(inputFileName) {
  var writer;
  console.log("closing writers for " + inputFileName);
  for (writer in files[inputFileName]) {
    console.log("writer to close: " + writer);
    files[inputFileName][writer].close();
  }
  return delete files[inputFileName];
  /*
  if files[inputFileName][writer].transports['file#text'].opening
    console.warn 'cannot close writer as it has not drained. queuing a retry.'
    console.dir files[inputFileName][writer].transports['file#text']
    setTimeout((() -> closer(inputFileName)), 2000) # this is a workaround as otherwise the Winston file writers don't really close
    return
  else
    #files[inputFileName][writer].clear() # should terminate all transports of the writer
    files[inputFileName][writer].close()
    delete files[inputFileName][writer]
  */

};
